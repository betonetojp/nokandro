# nokandro

パッケージ名: `com.nokakoi.nokandro`

## 概要

`nokandro` は Nostr プロトコルに接続して受信したメッセージを TTS（音声合成）で読み上げる軽量な Android アプリです。メイン画面からバックグラウンドのサービスを起動・停止でき、通知領域で動作を制御します。

## 主な機能

- リレー（WebSocket）へ接続してリアルタイムでイベントを受信する。デフォルト接続先は `wss://yabu.me` または設定されたリレー。
- 指定した `npub`（自分の公開鍵）に基づくフォローリストを取得して、フォローしているユーザーの投稿を優先して読み上げる。
- フォローしていないユーザーの投稿は設定により読み上げを無効化可能（「Allow others」切り替え）。
- フォロー済みユーザーとそれ以外で TTS の声を分けて指定可能（2つのボイス選択）。
- 受信したメッセージの表示（最後に受信した内容）とログの確認・共有（ロギングはビルド設定に依存し、配布ビルドでは非表示の場合があります）。
- バックグラウンドで常駐して TTS を行うサービスはフォアグラウンド通知を使用し、通知から停止操作が可能。

## インストールと初回起動（APK 配布）

1. 提供された APK をダウンロードしてインストールしてください。
2. 初回起動時にネットワークや通知などの権限を求められることがあります。許可しないと一部機能が制限されます。

## メイン画面の説明

- `Follow list: (not loaded)` — フォローリストの読み込み状態を表示します。
- `Public mute: (not loaded)` — 公開ミュートの読み込み状態を表示します。
- `Max characters:` — 表示用の最大文字数を入力します。
- `Relay (wss://...)` — 接続先リレーの URL を入力します。
- `Your npub` — 自分の npub（bech32）または 64 文字の hex 公開鍵を入力します。
- `Allow non-followed posts` — フォローしていない投稿を読み上げるかを切り替えます。
- `Voice for followed users` — フォロー済みユーザー用の TTS 音声を選択します。
- `Voice for others` — フォロー外ユーザー用の TTS 音声を選択します。
- `Refresh Voices` — 利用可能な TTS 音声を再取得します。
- `Start` — バックグラウンドサービスを開始します。
- `Stop` — バックグラウンドサービスを停止します。
- `(no note yet)` — ここに最後に受信したメッセージが表示されます。
- `Refresh Log` — ログ表示を更新します（`ENABLE_LOG` が有効な開発ビルド時のみ）。
- `Share Log` — ログを共有します（`ENABLE_LOG` が有効な開発ビルド時のみ）。

## フォローリストと公開ミュート（Follow list / Public mute）

- フォローリスト (Follow list): 指定した `npub` に紐づくフォローしている公開鍵の一覧をリレーから取得します。アプリはフォローリストの読み込み状態を画面上に表示し、フォロー済みの投稿は優先的に扱われ（別の TTS 音声や表示プレフィックスなど）、読み上げの判定に用いられます。

- 公開ミュート (Public mute): リレーやイベントで提供される公開ミュートリストに含まれる公開鍵は、読み上げ対象から除外されます。アプリは公開ミュートの読み込み状態も画面上に表示します。ミュートは読み上げのみの影響で、ログや内部記録の扱いは実装に依存します。

## 通知とサービス動作

- サービス起動中は通知領域に常駐し、「Stop」などのアクションからサービスを停止できます。
- Android 13 以上では通知の実行時許可（`POST_NOTIFICATIONS`）が必要になる場合があります。

## よくあるトラブルと対処法

- 受信できない／読み上げない:
  - `npub` が未設定、または `Allow others` がオフで該当ユーザーがフォローされていない可能性があります。
  - ネットワーク接続や指定したリレー URL を確認してください。
- TTS が再生されない:
  - 端末の音量・メディア音量を確認してください。
  - 選択した TTS の声が端末で利用できない場合はデフォルトの声にフォールバックされます。
- 通知から停止できない・サービスが落ちる:
  - 端末の電池最適化設定やアプリ権限を確認してください。

## 署名と安全性

- 配布される APK は配布元が署名しています。署名が異なる APK を上書きしようとするとインストールに失敗します。





