# nokandro — 利用ガイド（APK 配布向け・実際のアプリ仕様）

この README は配布用 APK を使うエンドユーザー向けに、実際のアプリ動作と UI に基づいた利用方法を説明します。

パッケージ名: `com.nokakoi.nokandro`

## 概要

`nokandro` は Nostr プロトコルに接続して受信したメッセージを TTS（音声合成）で読み上げる軽量な Android アプリです。メイン画面からバックグラウンドのサービスを起動・停止でき、通知領域で動作を制御します。

## 主な機能（ユーザー目線）

- リレー（WebSocket）へ接続してリアルタイムでイベントを受信する。デフォルト接続先は `wss://yabu.me` または設定されたリレー。
- 指定した `npub`（自分の公開鍵）に基づくフォローリストを取得して、フォローしているユーザーの投稿を優先して読み上げる。
- フォローしていないユーザーの投稿は設定により読み上げを無効化可能（「Allow others」切り替え）。
- フォロー済みユーザーとそれ以外で TTS の声を分けて指定可能（2つのボイス選択）。
- 受信したメッセージの表示（最後に受信した内容）とログの確認・共有（ロギングはビルド設定に依存し、配布ビルドでは非表示の場合があります）。
- バックグラウンドで常駐して TTS を行うサービスはフォアグラウンド通知を使用し、通知から停止操作が可能。

## インストールと初回起動（APK 配布）

1. 提供された APK をダウンロードしてインストールしてください。
2. 初回起動時にネットワークや通知などの権限を求められることがあります。許可しないと一部機能が制限されます。

## メイン画面の説明

- `Relay`（テキスト入力）: 接続先リレーの URL を入力します。
- `Npub`（テキスト入力）: 自分の npub（bech32）または 64 文字の hex 公開鍵を入力します。npub を入力するとアプリ側で hex に変換して使用します。
- `Allow others`（スイッチ）: フォローしていないユーザーの投稿を読み上げるかどうかを切り替えます。
- `Voice (followed)` / `Voice (other)`（スピナー）: フォロー済み／それ以外のメッセージ用に読み上げる声を選択します。
- `Truncate length`（数値）: 読み上げや表示の際にメッセージを何文字まで切り詰めるか指定します。
- `Start` ボタン: これらの設定を反映してバックグラウンドの Nostr サービスを起動します。サービスはフォアグラウンド通知を出します。
- `Stop` ボタン: サービスを停止します。
- ログ表示／共有ボタン: 開発ビルドでロギングが有効な場合にログを表示・共有できます（配布ビルドでは非表示の可能性あり）。

## 通知とサービス動作

- サービス起動中は通知領域に常駐し、「Stop」などのアクションからサービスを停止できます。
- Android 13 以上では通知の実行時許可（`POST_NOTIFICATIONS`）が必要になる場合があります。

## 入力形式とフォローリストの扱い

- `npub` は bech32（先頭が `npub`）または hex（64 文字）を受け付けます。npub は内部で hex にデコードされて使用されます。
- フォローリスト（kind=3 イベント）はリレーから取得され、タグ（`["p", "...pubkey..."]`）内の pubkey を抽出します。

## よくあるトラブルと対処法

- 受信できない／読み上げない:
  - `npub` が未設定、または `Allow others` がオフで該当ユーザーがフォローされていない可能性があります。
  - ネットワーク接続や指定したリレー URL を確認してください。
- TTS が再生されない:
  - 端末の音量・メディア音量を確認してください。
  - 選択した TTS の声が端末で利用できない場合はデフォルトの声にフォールバックされます。
- 通知から停止できない・サービスが落ちる:
  - 端末の電池最適化設定やアプリ権限を確認してください。

## 署名と安全性

- 配布される APK は配布元が署名しています。署名が異なる APK を上書きしようとするとインストールに失敗します。



